<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>StarPU Handbook: The StarPU Native Fortran Support</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">StarPU Handbook
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('NativeFortranSupport.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">The StarPU Native Fortran Support </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>StarPU provides the necessary routines and support to natively access most of its functionalities from Fortran 2008+ codes.</p>
<p>All symbols (functions, constants) are defined in <code>fstarpu_mod.f90</code>. Every symbol of the Native Fortran support API is prefixed by <code>fstarpu_</code>.</p>
<p>Note: Mixing uses of <code>fstarpu_</code> and <code>starpu_</code> symbols in the same Fortran code has unspecified behaviour. See <a class="el" href="NativeFortranSupport.html#NFAPIMIX">Valid API Mixes and Language Mixes</a> for a discussion about valid and unspecified combinations.</p>
<h1><a class="anchor" id="NFImplementation"></a>
Implementation Details and Specificities</h1>
<h2><a class="anchor" id="NFPrerequisites"></a>
Prerequisites</h2>
<p>The Native Fortran support relies on Fortran 2008 specific constructs, as well as on the support of interoperability of assumed-shape arrays introduced as part of Fortran's Technical Specification ISO/IEC TS 29113:2012, for which no equivalent are available in previous versions of the standard. It has currently been tested successfully with GNU GFortran 4.9, GFortran 5.x, GFortran 6.x and the Intel Fortran Compiler &gt;= 2016. It is known not to work with GNU GFortran &lt; 4.9, Intel Fortran Compiler &lt; 2016.</p>
<p>See Section <a class="el" href="NativeFortranSupport.html#NFOldFortran">Using StarPU with Older Fortran Compilers</a> on information on how to write StarPU Fortran code with older compilers.</p>
<h2><a class="anchor" id="NFConfiguration"></a>
Configuration</h2>
<p>The Native Fortran API is enabled and its companion <code>fstarpu_mod.f90</code> Fortran module source file is installed by default when a Fortran compiler is found, unless the detected Fortran compiler is known not to support the requirements for the Native Fortran API. The support can be disabled through the <code>configure</code> option <a class="el" href="CompilationConfiguration.html#disable-fortran">--disable-fortran</a>. Conditional compiled source codes may check for the availability of the Native Fortran Support by testing whether the preprocessor macro <code>STARPU_HAVE_FC</code> is defined or not.</p>
<h2><a class="anchor" id="NFExamples"></a>
Examples</h2>
<p>Several examples using the Native Fortran API are provided in StarPU's <code>examples/native_fortran/</code> examples directory, to showcase the Fortran flavor of various basic and more advanced StarPU features.</p>
<h2><a class="anchor" id="NFAppCompile"></a>
Compiling a Native Fortran Application</h2>
<p>The Fortran module <code>fstarpu_mod.f90</code> installed in StarPU's <code>include/</code> directory provides all the necessary API definitions. It must be compiled with the same compiler (same vendor, same version) as the application itself, and the resulting <code>fstarpu_mod.o</code> object file must linked with the application executable.</p>
<p>Each example provided in StarPU's <code>examples/native_fortran/</code> examples directory comes with its own dedicated Makefile for out-of-tree build. Such example Makefiles may be used as starting points for building application codes with StarPU.</p>
<h1><a class="anchor" id="NFIdioms"></a>
Fortran Translation for Common StarPU API Idioms</h1>
<p>All these examples assume that the standard Fortran module <code>iso_c_binding</code> is in use.</p>
<ul>
<li>Specifying a <code>NULL</code> pointer <div class="fragment"><div class="line"><span class="keywordtype">type</span>(c_ptr) :: my_ptr  <span class="comment">! variable to store the pointer</span></div><div class="line"><span class="comment">! [...]</span></div><div class="line">my_ptr = c_null_ptr    ! assign standard constant for null ptr</div></div><!-- fragment --></li>
<li>Obtaining a pointer to some object: <div class="fragment"><div class="line"><span class="keywordtype">real(8)</span>, <span class="keywordtype">dimension(:)</span>, <span class="keywordtype">allocatable</span>, <span class="keywordtype">target</span> :: va</div><div class="line"><span class="keywordtype">type</span>(c_ptr) :: p_va  <span class="comment">! variable to store a pointer to array va</span></div><div class="line"><span class="comment">! [...]</span></div><div class="line">p_va = c_loc(va)</div></div><!-- fragment --></li>
<li>Obtaining a pointer to some subroutine: <div class="fragment"><div class="line"><span class="comment">! pointed routine definition</span></div><div class="line"><span class="keyword">recursive subroutine </span>myfunc () bind(C)</div><div class="line"><span class="comment">! [...]</span></div><div class="line"><span class="keywordtype">type</span>(c_funptr) :: p_fun  <span class="comment">! variable to store the routine pointer</span></div><div class="line"><span class="comment">! [...]</span></div><div class="line">p_fun = c_funloc(my_func)</div></div><!-- fragment --></li>
<li>Obtaining the size of some object: <div class="fragment"><div class="line"><span class="keywordtype">real(8)</span> :: a</div><div class="line"><span class="keywordtype">integer(c_size_t)</span> :: sz_a  <span class="comment">! variable to store the size of a</span></div><div class="line"><span class="comment">! [...]</span></div><div class="line">sz_a = c_sizeof(a)</div></div><!-- fragment --></li>
<li>Obtaining the length of an array dimension: <div class="fragment"><div class="line"><span class="keywordtype">real(8)</span>, <span class="keywordtype">dimension(:,:)</span>, <span class="keywordtype">allocatable</span>, <span class="keywordtype">target</span> :: vb</div><div class="line">intger(c_int) :: ln_vb_1  <span class="comment">! variable to store the length of vb&#39;s dimension 1</span></div><div class="line">intger(c_int) :: ln_vb_2  <span class="comment">! variable to store the length of vb&#39;s dimension 2</span></div><div class="line"><span class="comment">! [...]</span></div><div class="line">ln_vb_1 = 1+ubound(vb,1)-lbound(vb,1)  <span class="comment">! get length of dimension 1 of vb</span></div><div class="line">ln_vb_2 = 1+ubound(vb,2)-lbound(vb,2)  ! get length of dimension 2 of vb</div></div><!-- fragment --></li>
<li>Specifying a string constant: <div class="fragment"><div class="line"><span class="keywordtype">type</span>(c_ptr) :: my_cl  <span class="comment">! a StarPU codelet</span></div><div class="line"><span class="comment">! [...]</span></div><div class="line"></div><div class="line"><span class="comment">! set the name of a codelet to string &#39;my_codele&#39;t:</span></div><div class="line"><span class="keyword">call </span>fstarpu_codelet_set_name(my_cl, c_char_<span class="stringliteral">&quot;my_codelet&quot;</span>//c_null_char)</div><div class="line"></div><div class="line"><span class="comment">! note: using the C_CHAR_ prefix and the //C_NULL_CHAR concatenation at the end ensures</span></div><div class="line"><span class="comment">! that the string constant is properly &#39;\0&#39; terminated, and compatible with StarPU&#39;s</span></div><div class="line"><span class="comment">! internal C routines</span></div><div class="line"><span class="comment">!</span></div><div class="line"><span class="comment">! note: plain Fortran string constants are not &#39;\0&#39; terminated, and as such, must not be</span></div><div class="line">! passed to starpu routines.</div></div><!-- fragment --></li>
<li>Combining multiple flag constants with a bitwise 'or': <div class="fragment"><div class="line"><span class="keywordtype">type</span>(c_ptr) :: my_cl  <span class="comment">! a pointer for the codelet structure</span></div><div class="line"><span class="comment">! [...]</span></div><div class="line"></div><div class="line"><span class="comment">! add a managed buffer to a codelet, specifying both the Read/Write access mode and the Locality hint</span></div><div class="line"><span class="keyword">call </span>fstarpu_codelet_add_buffer(my_cl, fstarpu_rw.ior.fstarpu_locality)</div></div><!-- fragment --></li>
</ul>
<h1><a class="anchor" id="NFInitExit"></a>
Uses, Initialization and Shutdown</h1>
<p>The snippet below show an example of minimal StarPU code using the Native Fortran support. The program should <code>use</code> the standard module <code>iso_c_binding</code> as well as StarPU's <code>fstarpu_mod</code>. The StarPU runtime engine is initialized with a call to function <code>fstarpu_init</code>, which returns an integer status of 0 if successful or non-0 otherwise. Eventually, a call to <code>fstarpu_shutdown</code> ends the runtime engine and frees all internal StarPU data structures.</p>
<div class="fragment"><div class="line"><span class="keyword">program</span> nf_initexit</div><div class="line">        <span class="keywordtype">use </span>iso_c_binding       <span class="comment">! C interfacing module</span></div><div class="line">        <span class="keywordtype">use </span>fstarpu_mod         <span class="comment">! StarPU interfacing module</span></div><div class="line">        <span class="keywordtype">implicit none</span>           <span class="comment">! Fortran recommended best practice</span></div><div class="line"></div><div class="line">        <span class="keywordtype">integer(c_int)</span> :: err   <span class="comment">! return status for fstarpu_init</span></div><div class="line"></div><div class="line">        <span class="comment">! initialize StarPU with default settings</span></div><div class="line">        err = fstarpu_init(c_null_ptr)</div><div class="line">        <span class="keywordflow">if</span> (err /= 0) <span class="keywordflow">then</span></div><div class="line">                stop 1          <span class="comment">! StarPU initialization failure</span></div><div class="line"><span class="keywordflow">        end if</span></div><div class="line"></div><div class="line">        <span class="comment">! - add StarPU Native Fortran API calls here</span></div><div class="line"></div><div class="line">        <span class="comment">! shut StarPU down</span></div><div class="line">        <span class="keyword">call </span><a class="code" href="interfacefstarpu__mod_1_1fstarpu__shutdown.html">fstarpu_shutdown</a>()</div><div class="line"><span class="keyword">end program </span>nf_initexit</div></div><!-- fragment --> <h1><a class="anchor" id="NFInsertTask"></a>
Fortran Flavor of StarPU's Variadic Insert_task</h1>
<p>Fortran does not have a construction similar to C variadic functions on which <a class="el" href="group__API__Insert__Task.html#ga2e9916071a4b6d60ae0b3c45854e4c9c">starpu_insert_task()</a> relies at the time of this writing. However, Fortran's variable length arrays of <code>c_ptr</code> elements enable to emulate much of the convenience of C's variadic functions. This is the approach retained for implementing <code>fstarpu_insert_task</code>.</p>
<p>The general syntax for using <code>fstarpu_insert_task</code> is as follows: </p><div class="fragment"><div class="line"><span class="comment">call fstarpu_insert_task((/ &lt;codelet ptr&gt;       &amp;</span></div><div class="line">    [, &lt;access mode flags&gt;, &lt;<span class="keyword">data</span> handle&gt;]*     &amp;</div><div class="line">    [, &lt;argument <span class="keyword">type</span> constant&gt;, &lt;argument&gt;]*   &amp;</div><div class="line">    , c_null_ptr /))</div></div><!-- fragment --><p>There is thus a unique array argument <code>(/ ... /)</code> passed to <code>fstarpu_insert_task</code> which itself contains the task settings. Each element of the array must be of type <code>type(c_ptr)</code>. The last element of the array must be <code>C_NULL_PTR</code>.</p>
<p>Example extracted from nf_vector.f90: </p><div class="fragment"><div class="line"><span class="comment">call fstarpu_insert_task((/ cl_vec,          &amp;    ! codelet</span></div><div class="line">    fstarpu_r, dh_va,                        &amp;    <span class="comment">! a first data handle</span></div><div class="line">    fstarpu_rw.ior.fstarpu_locality, dh_vb,  &amp;    <span class="comment">! a second data handle</span></div><div class="line">    c_null_ptr /))                                ! no more args</div></div><!-- fragment --><h1><a class="anchor" id="NFStructs"></a>
Functions and Subroutines Expecting Data Structures Arguments</h1>
<p>Several StarPU structures that are expected to be passed to the C API, are replaced by function/subroutine wrapper sets to allocate, set fields and free such structure. This strategy has been prefered over defining native Fortran equivalent of such structures using Fortran's derived types, to avoid potential layout mismatch between C and Fortran StarPU data structures. Examples of such data structures wrappers include <code>fstarpu_conf_allocate</code> and alike, <code>fstarpu_codelet_allocate</code> and alike, <code>fstarpu_data_filter_allocate</code> and alike.</p>
<p>Here is an example of allocating, filling and deallocating a codelet structure: </p><div class="fragment"><div class="line"><span class="comment">! a pointer for the codelet structure</span></div><div class="line"><span class="keywordtype">type</span>(c_ptr) :: cl_vec</div><div class="line"><span class="comment">! [...]</span></div><div class="line"><span class="comment">! allocate an empty codelet structure</span></div><div class="line">cl_vec = fstarpu_codelet_allocate()</div><div class="line"><span class="comment">! add a CPU implementation function to the codelet</span></div><div class="line"><span class="keyword">call </span>fstarpu_codelet_add_cpu_func(cl_vec, c_funloc(cl_cpu_func_vec))</div><div class="line"><span class="comment">! set the codelet name</span></div><div class="line"><span class="keyword">call </span>fstarpu_codelet_set_name(cl_vec, c_char_<span class="stringliteral">&quot;my_vec_codelet&quot;</span>//c_null_char)</div><div class="line"><span class="comment">! add a Read-only mode data buffer to the codelet</span></div><div class="line"><span class="keyword">call </span>fstarpu_codelet_add_buffer(cl_vec, fstarpu_r)</div><div class="line"><span class="comment">! add a Read-Write mode data buffer to the codelet</span></div><div class="line"><span class="keyword">call </span>fstarpu_codelet_add_buffer(cl_vec, fstarpu_rw.ior.fstarpu_locality)</div><div class="line"><span class="comment">! [...]</span></div><div class="line"><span class="comment">! free codelet structure</span></div><div class="line"><span class="keyword">call </span>fstarpu_codelet_free(cl_vec)</div></div><!-- fragment --><h1><a class="anchor" id="NFNotes"></a>
Additional Notes about the Native Fortran Support</h1>
<h2><a class="anchor" id="NFOldFortran"></a>
Using StarPU with Older Fortran Compilers</h2>
<p>When using older compilers, Fortran applications may still interoperate with StarPU using C marshalling functions as exemplified in StarPU's <code>examples/fortran/</code> and <code>examples/fortran90/</code> example directories, though the process will be less convenient.</p>
<p>Basically, the main FORTRAN code calls some C wrapper functions to submit tasks to StarPU. Then, when StarPU starts a task, another C wrapper function calls the FORTRAN routine for the task.</p>
<p>Note that this marshalled FORTRAN support remains available even when specifying <code>configure</code> option <a class="el" href="CompilationConfiguration.html#disable-fortran">--disable-fortran</a> (which only disables StarPU's native Fortran layer).</p>
<h2><a class="anchor" id="NFAPIMIX"></a>
Valid API Mixes and Language Mixes</h2>
<p>Mixing uses of <code>fstarpu_</code> and <code>starpu_</code> symbols in the same Fortran code has unspecified behaviour. Using <code>fstarpu_</code> symbols in C code has unspecified behaviour.</p>
<p>For multi-language applications using both C and Fortran source files:</p>
<ul>
<li>C source files must use <code>starpu_</code> symbols exclusively</li>
<li>Fortran sources must uniformly use either <code>fstarpu_</code> symbols exclusively, or <code>starpu_</code> symbols exclusively. Every other combination has unspecified behaviour. </li>
</ul>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Fri Oct 22 2021 15:02:16 for StarPU Handbook by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
