<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>StarPU Handbook: MIC Xeon Phi Support</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">StarPU Handbook
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('MICSupport.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">MIC Xeon Phi Support </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="MICCompilation"></a>
Compilation</h1>
<p>MIC Xeon Phi support actually needs two compilations of StarPU, one for the host and one for the device. The <code>PATH</code> environment variable has to include the path to the cross-compilation toolchain, for instance <code>/usr/linux-k1om-4.7/bin</code> . The <code>SINK_PKG_CONFIG_PATH</code> environment variable should include the path to the cross-compiled <code>hwloc.pc</code>. The script <code>mic-configure</code> can then be used to achieve the two compilations: it basically calls <code>configure</code> as appropriate from two new directories: <code>build_mic</code> and <code>build_host</code>. <code>make</code> and <code>make install</code> can then be used as usual and will recurse into both directories. If different <code>configure</code> options are needed for the host and for the mic, one can use <code>&ndash;with-host-param=&ndash;with-fxt</code> for instance to specify the <code>&ndash;with-fxt</code> option for the host only, or <code>&ndash;with-mic-param=&ndash;with-fxt</code> for the mic only.</p>
<p>One can also run StarPU just natively on the Xeon Phi, i.e. it will only run directly on the Phi without any exchange with the host CPU. The binaries in <code>build_mic</code> can be run that way.</p>
<p>For MPI support, you will probably have to specify different MPI compiler path or option for the host and the device builds, for instance:</p>
<pre class="fragment">./mic-configure --with-mic-param=--with-mpicc="/.../mpiicc -mmic" \
    --with-host-param=--with-mpicc=/.../mpiicc
</pre><p>In case you have troubles with the <code>coi</code> or <code>scif</code> libraries (the Intel paths are really not standard, it seems...), you can still make a build in native mode only, by using <code>mic-configure &ndash;enable-native-mic</code> (and notably without <code>&ndash;enable-mic</code> since in that case we don't need <code>mic</code> offloading support).</p>
<h1><a class="anchor" id="PortingApplicationsToMIC"></a>
Porting Applications To MIC Xeon Phi</h1>
<p>The simplest way to port an application to MIC Xeon Phi is to set the field <a class="el" href="group__API__Codelet__And__Tasks.html#abfc0aa8247673ad1c629d5ddd30082a3">starpu_codelet::cpu_funcs_name</a>, to provide StarPU with the function name of the CPU implementation, so for instance:</p>
<pre class="fragment">struct starpu_codelet cl =
{
    .cpu_funcs = {myfunc},
    .cpu_funcs_name = {"myfunc"},
    .nbuffers = 1,
}
</pre><p>StarPU will thus simply use the existing CPU implementation (cross-rebuilt in the MIC Xeon Phi case). The functions have to be globally-visible (i.e. not <code>static</code>) for StarPU to be able to look them up, and <code>-rdynamic</code> must be passed to <code>gcc</code> (or <code>-export-dynamic</code> to <code>ld</code>) so that symbols of the main program are visible.</p>
<p>If you have used the <a class="el" href="group__API__Codelet__And__Tasks.html#a504b8e20f53f469358eadb1ed800f72c">starpu_codelet::where</a> field, you additionally need to add in it <a class="el" href="group__API__Codelet__And__Tasks.html#ga6f980630004573f662253ff25317382e">STARPU_MIC</a> for the Xeon Phi.</p>
<p>For non-native MIC Xeon Phi execution, the 'main' function of the application, on the sink, should call <a class="el" href="group__API__Initialization__and__Termination.html#ga9ce171bcbbee2edd169ba2649e6e75e3">starpu_init()</a> immediately upon start-up; the <a class="el" href="group__API__Initialization__and__Termination.html#ga9ce171bcbbee2edd169ba2649e6e75e3">starpu_init()</a> function never returns. On the host, the 'main' function may freely perform application related initialization calls as usual, before calling <a class="el" href="group__API__Initialization__and__Termination.html#ga9ce171bcbbee2edd169ba2649e6e75e3">starpu_init()</a>.</p>
<p>For MIC Xeon Phi, the application may programmatically detect whether executing on the sink or on the host, by checking whether the <a class="el" href="ExecutionConfigurationThroughEnvironmentVariables.html#STARPU_SINK">STARPU_SINK</a> environment variable is defined (on the sink) or not (on the host).</p>
<h1><a class="anchor" id="LaunchingPrograms"></a>
Launching Programs</h1>
<p>MIC programs are started from the host. StarPU automatically starts the same program on MIC devices. It however needs to get the MIC-cross-built binary. It will look for the file given by the environment variable <a class="el" href="ExecutionConfigurationThroughEnvironmentVariables.html#STARPU_MIC_SINK_PROGRAM_NAME">STARPU_MIC_SINK_PROGRAM_NAME</a> or in the directory given by the environment variable <a class="el" href="ExecutionConfigurationThroughEnvironmentVariables.html#STARPU_MIC_SINK_PROGRAM_PATH">STARPU_MIC_SINK_PROGRAM_PATH</a>, or in the field <a class="el" href="group__API__Initialization__and__Termination.html#a57b051ea320e884b3c93cadb9f5e8b8b">starpu_conf::mic_sink_program_path</a>. It will also look in the current directory for the same binary name plus the suffix <code>-mic</code> or <code>_mic</code>.</p>
<p>The testsuite can be started by simply running <code>make check</code> from the top directory. It will recurse into both <code>build_host</code> to run tests with only the host, and into <code>build_mic</code> to run tests with both the host and the MIC devices. Single tests with the host and the MIC can be run by starting <code>./loader-cross.sh ./the_test</code> from <code>build_mic/tests</code>. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Fri Oct 22 2021 15:02:16 for StarPU Handbook by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
