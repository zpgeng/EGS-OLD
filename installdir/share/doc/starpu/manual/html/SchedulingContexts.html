<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>StarPU Handbook: Scheduling Contexts</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">StarPU Handbook
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('SchedulingContexts.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Scheduling Contexts </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>TODO: improve!</p>
<h1><a class="anchor" id="ContextGeneralIdeas"></a>
General Ideas</h1>
<p>Scheduling contexts represent abstracts sets of workers that allow the programmers to control the distribution of computational resources (i.e. CPUs and GPUs) to concurrent kernels. The main goal is to minimize interferences between the execution of multiple parallel kernels, by partitioning the underlying pool of workers using contexts. Scheduling contexts additionally allow a user to make use of a different scheduling policy depending on the target resource set.</p>
<h1><a class="anchor" id="CreatingAContext"></a>
Creating A Context</h1>
<p>By default, the application submits tasks to an initial context, which disposes of all the computation resources available to StarPU (all the workers). If the application programmer plans to launch several kernels simultaneously, by default these kernels will be executed within this initial context, using a single scheduler policy(see <a class="el" href="Scheduling.html#TaskSchedulingPolicy">Task Scheduling Policies</a>). Meanwhile, if the application programmer is aware of the demands of these kernels and of the specificity of the machine used to execute them, the workers can be divided between several contexts. These scheduling contexts will isolate the execution of each kernel and they will permit the use of a scheduling policy proper to each one of them.</p>
<p>Scheduling Contexts may be created in two ways: either the programmers indicates the set of workers corresponding to each context (providing he knows the identifiers of the workers running within StarPU), or the programmer does not provide any worker list and leaves the Hypervisor assign workers to each context according to their needs (<a class="el" href="SchedulingContextHypervisor.html">Scheduling Context Hypervisor</a>).</p>
<p>Both cases require a call to the function <a class="el" href="group__API__Scheduling__Contexts.html#ga517b7cf4bfac60f2faf484584f19d9d3">starpu_sched_ctx_create()</a>, which requires as input the worker list (the exact list or a <code>NULL</code> pointer), the amount of workers (or <code>-1</code> to designate all workers on the platform) and a list of optional parameters such as the scheduling policy, terminated by a <code>0</code>. The scheduling policy can be a character list corresponding to the name of a StarPU predefined policy or the pointer to a custom policy. The function returns an identifier of the context created which you will use to indicate the context you want to submit the tasks to.</p>
<div class="fragment"><div class="line"><span class="comment">/* the list of resources the context will manage */</span></div><div class="line"><span class="keywordtype">int</span> workerids[3] = {1, 3, 10};</div><div class="line"></div><div class="line"><span class="comment">/* indicate the list of workers assigned to it, the number of workers,</span></div><div class="line"><span class="comment">the name of the context and the scheduling policy to be used within</span></div><div class="line"><span class="comment">the context */</span></div><div class="line"><span class="keywordtype">int</span> id_ctx = <a class="code" href="group__API__Scheduling__Contexts.html#ga517b7cf4bfac60f2faf484584f19d9d3">starpu_sched_ctx_create</a>(workerids, 3, <span class="stringliteral">&quot;my_ctx&quot;</span>, <a class="code" href="group__API__Scheduling__Contexts.html#ga66ed9279fc4eb746a0596c2f0be7daa2">STARPU_SCHED_CTX_POLICY_NAME</a>, <span class="stringliteral">&quot;dmda&quot;</span>, 0);</div><div class="line"></div><div class="line"><span class="comment">/* let StarPU know that the following tasks will be submitted to this context */</span></div><div class="line"><a class="code" href="group__API__Scheduling__Contexts.html#ga4e1aaf03ba327f47e5027c6fb7e5ed00">starpu_sched_ctx_set_context</a>(<span class="keywordtype">id</span>);</div><div class="line"></div><div class="line"><span class="comment">/* submit the task to StarPU */</span></div><div class="line"><a class="code" href="group__API__Codelet__And__Tasks.html#gaa32228bf7f452f7d664986668ea46590">starpu_task_submit</a>(task);</div></div><!-- fragment --><p>Note: Parallel greedy and parallel heft scheduling policies do not support the existence of several disjoint contexts on the machine. Combined workers are constructed depending on the entire topology of the machine, not only the one belonging to a context.</p>
<h2><a class="anchor" id="CreatingAContextWithTheDefaultBehavior"></a>
Creating A Context With The Default Behavior</h2>
<p>If <b>no scheduling policy</b> is specified when creating the context, it will be used as <b>another type of resource</b>: a cluster. A cluster is a context without scheduler (eventually delegated to another runtime). For more information see <a class="el" href="ClusteringAMachine.html">Clustering A Machine</a>. It is therefore <b>mandatory</b> to stipulate a scheduler to use the contexts in this traditional way.</p>
<p>To create a <b>context</b> with the default scheduler, that is either controlled through the environment variable <code>STARPU_SCHED</code> or the StarPU default scheduler, one can explicitly use the option <code>STARPU_SCHED_CTX_POLICY_NAME, ""</code> as in the following example:</p>
<div class="fragment"><div class="line"><span class="comment">/* the list of resources the context will manage */</span></div><div class="line"><span class="keywordtype">int</span> workerids[3] = {1, 3, 10};</div><div class="line"></div><div class="line"><span class="comment">/* indicate the list of workers assigned to it, the number of workers,</span></div><div class="line"><span class="comment">and use the default scheduling policy. */</span></div><div class="line"><span class="keywordtype">int</span> id_ctx = <a class="code" href="group__API__Scheduling__Contexts.html#ga517b7cf4bfac60f2faf484584f19d9d3">starpu_sched_ctx_create</a>(workerids, 3, <span class="stringliteral">&quot;my_ctx&quot;</span>, <a class="code" href="group__API__Scheduling__Contexts.html#ga66ed9279fc4eb746a0596c2f0be7daa2">STARPU_SCHED_CTX_POLICY_NAME</a>, <span class="stringliteral">&quot;&quot;</span>, 0);</div><div class="line"></div><div class="line"><span class="comment">/* .... */</span></div></div><!-- fragment --><h1><a class="anchor" id="CreatingAGPUContext"></a>
Creating A Context To Partition a GPU</h1>
<p>The contexts can also be used to group set of SMs of an NVIDIA GPU in order to isolate the parallel kernels and allow them to coexecution on a specified partiton of the GPU.</p>
<p>Each context will be mapped to a stream and the user can indicate the number of SMs. The context can be added to a larger context already grouping CPU cores. This larger context can use a scheduling policy that assigns tasks to both CPUs and contexts (partitions of the GPU) based on performance models adjusted to the number of SMs.</p>
<p>The GPU implementation of the task has to be modified accordingly and receive as a parameter the number of SMs.</p>
<div class="fragment"><div class="line"><span class="comment">/* get the available streams (suppose we have nstreams = 2 by specifying them with STARPU_NWORKER_PER_CUDA=2  */</span></div><div class="line"><span class="keywordtype">int</span> nstreams = starpu_worker_get_stream_workerids(gpu_devid, stream_workerids, <a class="code" href="group__API__Workers__Properties.html#gga173d616aefe98c33a47a847fd2fca37da26ced4e9dfc43343f0b442bb465218a9">STARPU_CUDA_WORKER</a>);</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> sched_ctx[nstreams];</div><div class="line">sched_ctx[0] = <a class="code" href="group__API__Scheduling__Contexts.html#ga517b7cf4bfac60f2faf484584f19d9d3">starpu_sched_ctx_create</a>(&amp;stream_workerids[0], 1, <span class="stringliteral">&quot;subctx&quot;</span>,  <a class="code" href="group__API__Scheduling__Contexts.html#ga1e642fe68ccbb8c5c661aab6c0d81283">STARPU_SCHED_CTX_CUDA_NSMS</a>, 6, 0);</div><div class="line">sched_ctx[1] = <a class="code" href="group__API__Scheduling__Contexts.html#ga517b7cf4bfac60f2faf484584f19d9d3">starpu_sched_ctx_create</a>(&amp;stream_workerids[1], 1, <span class="stringliteral">&quot;subctx&quot;</span>,  <a class="code" href="group__API__Scheduling__Contexts.html#ga1e642fe68ccbb8c5c661aab6c0d81283">STARPU_SCHED_CTX_CUDA_NSMS</a>, 7, 0);</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> <a class="code" href="group__API__Initialization__and__Termination.html#a68e93f60a9f8e4c82ab2af6a9cd3888a">ncpus</a> = 4;</div><div class="line"><span class="keywordtype">int</span> workers[ncpus+nstreams];</div><div class="line">workers[ncpus+0] = stream_workerids[0];</div><div class="line">workers[ncpus+1] = stream_workerids[1];</div><div class="line"></div><div class="line">big_sched_ctx = <a class="code" href="group__API__Scheduling__Contexts.html#ga517b7cf4bfac60f2faf484584f19d9d3">starpu_sched_ctx_create</a>(workers, ncpus+nstreams, <span class="stringliteral">&quot;ctx1&quot;</span>, <a class="code" href="group__API__Scheduling__Contexts.html#ga0ef17ebcd4b58381d71423c93948ad42">STARPU_SCHED_CTX_SUB_CTXS</a>, sched_ctxs, nstreams, <a class="code" href="group__API__Scheduling__Contexts.html#ga66ed9279fc4eb746a0596c2f0be7daa2">STARPU_SCHED_CTX_POLICY_NAME</a>, <span class="stringliteral">&quot;dmdas&quot;</span>, 0);</div><div class="line"></div><div class="line"><a class="code" href="group__API__Codelet__And__Tasks.html#ga3c6c4dd317df02d7021e23ab6b14e3e2">starpu_task_submit_to_ctx</a>(task, big_sched_ctx);</div></div><!-- fragment --><h1><a class="anchor" id="ModifyingAContext"></a>
Modifying A Context</h1>
<p>A scheduling context can be modified dynamically. The application may change its requirements during the execution and the programmer can add additional workers to a context or remove those no longer needed. In the following example we have two scheduling contexts <code>sched_ctx1</code> and <code>sched_ctx2</code>. After executing a part of the tasks some of the workers of <code>sched_ctx1</code> will be moved to context <code>sched_ctx2</code>.</p>
<div class="fragment"><div class="line"><span class="comment">/* the list of ressources that context 1 will give away */</span></div><div class="line"><span class="keywordtype">int</span> workerids[3] = {1, 3, 10};</div><div class="line"></div><div class="line"><span class="comment">/* add the workers to context 1 */</span></div><div class="line"><a class="code" href="group__API__Scheduling__Contexts.html#gaaf3b5065cf505e6352070f2737a672a0">starpu_sched_ctx_add_workers</a>(workerids, 3, sched_ctx2);</div><div class="line"></div><div class="line"><span class="comment">/* remove the workers from context 2 */</span></div><div class="line"><a class="code" href="group__API__Scheduling__Contexts.html#ga31a7eb9cb2f0e68a38ff3e613c7df34f">starpu_sched_ctx_remove_workers</a>(workerids, 3, sched_ctx1);</div></div><!-- fragment --><h1><a class="anchor" id="SubmittingTasksToAContext"></a>
Submitting Tasks To A Context</h1>
<p>The application may submit tasks to several contexts either simultaneously or sequnetially. If several threads of submission are used the function <a class="el" href="group__API__Scheduling__Contexts.html#ga4e1aaf03ba327f47e5027c6fb7e5ed00">starpu_sched_ctx_set_context()</a> may be called just before <a class="el" href="group__API__Codelet__And__Tasks.html#gaa32228bf7f452f7d664986668ea46590">starpu_task_submit()</a>. Thus StarPU considers that the current thread will submit tasks to the coresponding context.</p>
<p>When the application may not assign a thread of submission to each context, the id of the context must be indicated by using the function <a class="el" href="group__API__Codelet__And__Tasks.html#ga3c6c4dd317df02d7021e23ab6b14e3e2">starpu_task_submit_to_ctx()</a> or the field <a class="el" href="group__API__Insert__Task.html#ga45ae06dad37b9a8518198b1c3b06f276">STARPU_SCHED_CTX</a> for <a class="el" href="group__API__Insert__Task.html#gad79a50a21fe717126659b2998209c1c6">starpu_task_insert()</a>.</p>
<h1><a class="anchor" id="DeletingAContext"></a>
Deleting A Context</h1>
<p>When a context is no longer needed it must be deleted. The application can indicate which context should keep the resources of a deleted one. All the tasks of the context should be executed before doing this. Thus, the programmer may use either a barrier and then delete the context directly, or just indicate that other tasks will not be submitted later on to the context (such that when the last task is executed its workers will be moved to the inheritor) and delete the context at the end of the execution (when a barrier will be used eventually).</p>
<div class="fragment"><div class="line"><span class="comment">/* when the context 2 is deleted context 1 inherits its resources */</span></div><div class="line"><a class="code" href="group__API__Scheduling__Contexts.html#gad6b7f96254526bb145e0df5ed0354a13">starpu_sched_ctx_set_inheritor</a>(sched_ctx2, sched_ctx1);</div><div class="line"></div><div class="line"><span class="comment">/* submit tasks to context 2 */</span></div><div class="line"><span class="keywordflow">for</span> (i = 0; i &lt; ntasks; i++)</div><div class="line">    <a class="code" href="group__API__Codelet__And__Tasks.html#ga3c6c4dd317df02d7021e23ab6b14e3e2">starpu_task_submit_to_ctx</a>(task[i],sched_ctx2);</div><div class="line"></div><div class="line"><span class="comment">/* indicate that context 2 finished submitting and that */</span></div><div class="line"><span class="comment">/* as soon as the last task of context 2 finished executing */</span></div><div class="line"><span class="comment">/* its workers can be moved to the inheritor context */</span></div><div class="line"><a class="code" href="group__API__Scheduling__Contexts.html#ga11e94f2968626d9b46ccf021057ddd90">starpu_sched_ctx_finished_submit</a>(sched_ctx1);</div><div class="line"></div><div class="line"><span class="comment">/* wait for the tasks of both contexts to finish */</span></div><div class="line"><a class="code" href="group__API__Codelet__And__Tasks.html#gad0baa8dbfd13e5a7bc3651bcd76022aa">starpu_task_wait_for_all</a>();</div><div class="line"></div><div class="line"><span class="comment">/* delete context 2 */</span></div><div class="line"><a class="code" href="group__API__Scheduling__Contexts.html#ga101c3a13d4adc8d932c46324ae71b93a">starpu_sched_ctx_delete</a>(sched_ctx2);</div><div class="line"></div><div class="line"><span class="comment">/* delete context 1 */</span></div><div class="line"><a class="code" href="group__API__Scheduling__Contexts.html#ga101c3a13d4adc8d932c46324ae71b93a">starpu_sched_ctx_delete</a>(sched_ctx1);</div></div><!-- fragment --><h1><a class="anchor" id="EmptyingAContext"></a>
Emptying A Context</h1>
<p>A context may have no resources at the begining or at a certain moment of the execution. Tasks can still be submitted to these contexts and they will be executed as soon as the contexts will have resources. A list of tasks pending to be executed is kept and will be submitted when workers are added to the contexts.</p>
<div class="fragment"><div class="line"><span class="comment">/* create a empty context */</span></div><div class="line"><span class="keywordtype">unsigned</span> sched_ctx_id = <a class="code" href="group__API__Scheduling__Contexts.html#ga517b7cf4bfac60f2faf484584f19d9d3">starpu_sched_ctx_create</a>(NULL, 0, <span class="stringliteral">&quot;ctx&quot;</span>, 0);</div><div class="line"></div><div class="line"><span class="comment">/* submit a task to this context */</span></div><div class="line"><a class="code" href="group__API__Scheduling__Contexts.html#ga4e1aaf03ba327f47e5027c6fb7e5ed00">starpu_sched_ctx_set_context</a>(&amp;sched_ctx_id);</div><div class="line">ret = <a class="code" href="group__API__Insert__Task.html#gad79a50a21fe717126659b2998209c1c6">starpu_task_insert</a>(&amp;codelet, 0);</div><div class="line"><a class="code" href="group__API__Toolbox.html#gaa3503ea5efd00806a0f9234f033e6ea1">STARPU_CHECK_RETURN_VALUE</a>(ret, <span class="stringliteral">&quot;starpu_task_insert&quot;</span>);</div><div class="line"></div><div class="line"><span class="comment">/* add CPU workers to the context */</span></div><div class="line"><span class="keywordtype">int</span> procs[<a class="code" href="group__API__Workers__Properties.html#gad7c443d1341e4976d63fb5d77e74bf09">STARPU_NMAXWORKERS</a>];</div><div class="line"><span class="keywordtype">int</span> nprocs = <a class="code" href="group__API__Workers__Properties.html#ga8c4e370ff327c38a3ec79c9249ab233a">starpu_cpu_worker_get_count</a>();</div><div class="line"><a class="code" href="group__API__Workers__Properties.html#gae1ab43056f2c28ed3826e80c5a86a0fc">starpu_worker_get_ids_by_type</a>(<a class="code" href="group__API__Workers__Properties.html#gga173d616aefe98c33a47a847fd2fca37da7fa269b896814504abcf227388233d1f">STARPU_CPU_WORKER</a>, procs, nprocs);</div><div class="line"><a class="code" href="group__API__Scheduling__Contexts.html#gaaf3b5065cf505e6352070f2737a672a0">starpu_sched_ctx_add_workers</a>(procs, nprocs, sched_ctx_id);</div><div class="line"></div><div class="line"><span class="comment">/* and wait for the task termination */</span></div><div class="line"><a class="code" href="group__API__Codelet__And__Tasks.html#gad0baa8dbfd13e5a7bc3651bcd76022aa">starpu_task_wait_for_all</a>();</div></div><!-- fragment --><p>However, if resources are never allocated to the context, the application will not terminate. If these tasks have low priority, the application can inform StarPU to not submit them by calling the function <a class="el" href="group__API__Scheduling__Contexts.html#gafe295aec3c152fe1fc0dd74e17f82961">starpu_sched_ctx_stop_task_submission()</a>. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Fri Oct 22 2021 15:02:13 for StarPU Handbook by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
